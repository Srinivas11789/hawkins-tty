#!/usr/bin/env bash
# hawkins-shell - Launch a new shell with Hawkins Terminal enabled
#
# Usage:
#   hawkins-shell        # Launch interactive Hawkins shell
#
# This allows you to enjoy Hawkins Terminal in a specific window
# without enabling it system-wide.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HAWKINS_SH="$SCRIPT_DIR/shell/hawkins.sh"

# Check if hawkins.sh exists
if [[ ! -f "$HAWKINS_SH" ]]; then
    # Try installed location
    if [[ -f "$HOME/.local/share/hawkins-terminal/shell/hawkins.sh" ]]; then
        HAWKINS_SH="$HOME/.local/share/hawkins-terminal/shell/hawkins.sh"
    elif [[ -f "$HOME/.config/hawkins-terminal/shell/hawkins.sh" ]]; then
        HAWKINS_SH="$HOME/.config/hawkins-terminal/shell/hawkins.sh"
    else
        echo "Error: hawkins.sh not found" >&2
        exit 1
    fi
fi

# Detect user's preferred shell
USER_SHELL="${SHELL:-/bin/bash}"
SHELL_NAME="$(basename "$USER_SHELL")"

case "$SHELL_NAME" in
    zsh)
        # For zsh: create temp directory with .zshrc
        HAWKINS_ZDOTDIR=$(mktemp -d "${TMPDIR:-/tmp}/hawkins-zsh.XXXXXX")
        cat > "$HAWKINS_ZDOTDIR/.zshrc" << EOF
# Load user's zshrc first (using original ZDOTDIR or HOME)
if [[ -f "\${_HAWKINS_ORIG_ZDOTDIR:-\$HOME}/.zshrc" ]]; then
    source "\${_HAWKINS_ORIG_ZDOTDIR:-\$HOME}/.zshrc"
fi

# Load Hawkins Terminal
source '$HAWKINS_SH'

# Cleanup temp directory on exit
trap "rm -rf '$HAWKINS_ZDOTDIR'" EXIT
EOF
        # Save original ZDOTDIR and launch
        export _HAWKINS_ORIG_ZDOTDIR="${ZDOTDIR:-$HOME}"
        export ZDOTDIR="$HAWKINS_ZDOTDIR"
        exec zsh -i
        ;;
    bash)
        # For bash: use --rcfile with temp file
        HAWKINS_RC=$(mktemp "${TMPDIR:-/tmp}/hawkins-bashrc.XXXXXX")
        cat > "$HAWKINS_RC" << EOF
# Load user's bashrc first
[[ -f ~/.bashrc ]] && source ~/.bashrc

# Load Hawkins Terminal
source '$HAWKINS_SH'

# Cleanup temp file on exit
trap "rm -f '$HAWKINS_RC'" EXIT
EOF
        exec bash --rcfile "$HAWKINS_RC" -i
        ;;
    *)
        # Fallback to bash
        HAWKINS_RC=$(mktemp "${TMPDIR:-/tmp}/hawkins-bashrc.XXXXXX")
        cat > "$HAWKINS_RC" << EOF
source '$HAWKINS_SH'
trap "rm -f '$HAWKINS_RC'" EXIT
EOF
        exec bash --rcfile "$HAWKINS_RC" -i
        ;;
esac
